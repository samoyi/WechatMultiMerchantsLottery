<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>seiri</title>
</head>
<body>
    <div id="merchants">

    </div>
    <div>
        <h2>添加商户</h2>
        <p>
            <input id="merchantName" type="text" required placeholder="商户名" /><br />
            <input id="addMerchantBtn" type="button" value="添加" />
        </p>
    </div>
    <div>
        <h2>添加奖品</h2>
        <p>
            <input id="prizeName" type="text" required placeholder="奖品名" /><br />
            <input id="merchantNameForAddPrize" type="text" required placeholder="商户名" /><br />
            <input id="percent" type="number" min="0" max="100" step="1" required placeholder="中奖概率" />%<br />
            <input id="total" type="number" min="1" step="1" required placeholder="奖品总数" /><br />
            <input id="addPrizeBtn" type="button" value="添加" />
        </p>
    </div>
</body>
<script>
'use strict';

let oMerchant = {};


{
    AJAX_GET('addData.php?act=get_prizes',
    res=>{
        let sInnerHTML = '';

        let oPrizes = JSON.parse(res);

        AJAX_GET('addData.php?act=get_merchants',
            res=>{
                let sInnerHTML = '';
                let aMerchant = JSON.parse(res);
                aMerchant.forEach(item=>{
                    oMerchant[item.merchantName] = [];
                    console.log(oPrizes[item.merchantID]);
                    if(oPrizes[item.merchantID]){
                        oPrizes[item.merchantID].forEach(prize=>{

                            sInnerHTML += '<li>' +prize.prizeName+ '</li>';
                            oMerchant[item.merchantName].push(prize.prizeName);
                        });
                        sInnerHTML = '<li>' + item.merchantName + '<ul>' + sInnerHTML + '</ul></li>';
                    }
                    else{
                        sInnerHTML += '<li>' +item.merchantName+ '</li>';
                    }
                });
                document.querySelector('#merchants').innerHTML = '<h2>现有商户：</h2><ol>' + sInnerHTML+ '</ol>';
                console.log(oMerchant);
            },
            err=>{
                alert(err);
                console.error(err);
            })
    },
    err=>{
        alert(err);
        console.error(err);
    })
}

{
    document.querySelector('#addMerchantBtn').addEventListener('click', function(){
        let merchant = document.querySelector('#merchantName').value.trim();
        if(merchant in oMerchant){
            alert('该商户已存在');
            return;
        }

        let data = 'act=add_merchant&merchant=' + merchant;
        AJAX_POST('addData.php', data,
            res=>{
                console.log(res);
            },
            err=>{
                alert(err);
                console.error(err);
            });
    });
}






{
    document.querySelector('#addPrizeBtn').addEventListener('click', function(){
        let merchant = document.querySelector('#merchantNameForAddPrize').value.trim();
        if(!(merchant in oMerchant)){
            alert('该商户不存在');
            return;
        }

        let sPrizeName = document.querySelector('#prizeName').value,
             nPercent= document.querySelector('#percent').value,
             nTotal= document.querySelector('#total').value;

         if(sPrizeName in oMerchant.merchant){
             alert('该商户已有该奖品');
             return;
         }

        let data = 'act=add_prize&merchant=' + merchant
                    + '&prize_name=' + sPrizeName
                    + '&probability_percent=' + nPercent
                    + '&total=' + nTotal;
        AJAX_POST('addData.php', data,
            res=>{
                console.log(res);
            },
            err=>{
                alert(err);
                console.error(err);
            });
    });
}




    function AJAX_GET(sURL, fnSuccessCallback, fnFailCallback)
    {
        let xhr = new XMLHttpRequest();
        xhr.addEventListener('readystatechange', function()
        {
            if (xhr.readyState == 4)
            {
                if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304){
                    // 必要的时候，使用 getResponseHeader() 检查首部信息
                    fnSuccessCallback && fnSuccessCallback( xhr.responseText );
                }
                else{
                    fnFailCallback && fnFailCallback( xhr.status );
                }
            }
        }, false);
        xhr.open("get", sURL, true);
        xhr.send(null);
    }

    function AJAX_POST(sURL, data, fnSuccessCallback, fnFailCallback)
	{
		let xhr = new XMLHttpRequest();
		xhr.addEventListener('readystatechange', function()
		{
			if (xhr.readyState == 4)
			{
				if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304){
					// 必要的时候，使用 getResponseHeader() 检查首部信息
					fnSuccessCallback && fnSuccessCallback( xhr.responseText );
				}
				else{
					fnFailCallback && fnFailCallback( xhr.status );
				}
			}
		}, false);
		xhr.open("post", sURL, true);
		// 如果发送FormDate，则不需要设置Content-Type，但截至2017.5，FormDate的浏览器支持并不理想
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		xhr.send(data);
	}
</script>
</html>
